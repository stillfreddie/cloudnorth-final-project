pipeline {
  agent any

  environment {
    PATH = "/usr/local/go/bin:$PATH"
    AWS_ACCESS_KEY_ID = credentials('aws-access-key')
    AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Code Quality - Linting') {
      steps {
        script {
          echo "ğŸ” Running Golang linter..."
          sh '''
            cd backend
            golangci-lint run
          '''
        }
      }
    }

    stage('Run Unit Tests') {
      steps {
        script {
          echo "ğŸ§ª Running Go Unit Tests..."
          sh '''
            cd backend
            go test ./...
          '''
        }
      }
    }

    stage('Build Docker Images') {
      steps {
        script {
          withCredentials([usernamePassword(
            credentialsId: 'dockerhub-creds',
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) {
            sh '''
              echo "ğŸ” Logging into DockerHub..."
              echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

              echo "ğŸ³ Building Docker images..."
              docker build -t stillfreddie/cloudnorth-frontend:${BUILD_NUMBER} ./frontend
              docker build -t stillfreddie/cloudnorth-backend:${BUILD_NUMBER} ./backend

              echo "ğŸ“¦ Pushing Docker images to DockerHub..."
              docker push stillfreddie/cloudnorth-frontend:${BUILD_NUMBER}
              docker push stillfreddie/cloudnorth-backend:${BUILD_NUMBER}
            '''
          }
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        script {
          echo "ğŸš€ Deploying to EKS using Helm..."

          sh '''
            echo "ğŸ”§ Checking current kubectl context..."
            kubectl config current-context

            echo "ğŸ” Ensuring namespace exists..."
            kubectl get ns cloudnorth-ns || kubectl create ns cloudnorth-ns

            echo "ğŸ“¦ Deploying Frontend..."
            helm upgrade --install frontend-blue ./helm/frontend \
              -n cloudnorth-ns \
              -f ./helm/frontend/values-blue.yaml \
              --set image.repository=stillfreddie/cloudnorth-frontend \
              --set image.tag=${BUILD_NUMBER}

            echo "ğŸ“¦ Deploying Backend..."
            helm upgrade --install cloudnorth-backend ./helm/backend \
              -n cloudnorth-ns \
              -f ./helm/backend/values-blue.yaml \
              --set image.repository=stillfreddie/cloudnorth-backend \
              --set image.tag="${BUILD_NUMBER}"
        
          '''
        }
      }
    }

  }

  post {
    success {
      echo "âœ… Build, push, and deployment completed successfully!"
    }
    failure {
      echo "âŒ Build or deployment failed. Please check the Jenkins logs for errors."
    }
  }
}